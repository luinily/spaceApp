//
//  ApodPresenter.swift
//  spaceApp
//
//  Created by Coldefy Yoann on 2016/07/17.
//  Copyright (c) 2016年 YoannColdefy. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so you can apply
//  clean architecture to your iOS and Mac projects, see http://clean-swift.com
//

import UIKit

protocol ApodPresenterInput {
	func presentApod(response: ApodResponse)
	func presentError(response: ApodErrorResponse)
	func presentPictureDownloadProgress(response: ApodPictureDownloadProgressResponse)
	func presentPicture(response: ApodPictureResponse)
}

protocol ApodPresenterOutput: class {
	func displayApod(viewModel: ApodDataViewModel)
	func displayApodError(viewModel: ApodErrorViewModel)
	func displayImage(viewModel: ApodImageViewModel)
	func displayProgress(viewModel: ApodPictureDownloadProgressViewModel)
}

class ApodPresenter: ApodPresenterInput {
	weak var output: ApodPresenterOutput!

	private let dateFormat = "yyyy年MM月dd日"
	private let copyrightHeader = "Image Credits: "
	private let publicDomain = "Public Domain"
	// MARK: Presentation logic

	func presentApod(response: ApodResponse) {
		let apodViewModel = makeApodViewModel(apodData: response.apodData)
		output.displayApod(viewModel: apodViewModel)
	}

	private func makeApodViewModel(apodData: ApodData) -> ApodDataViewModel {
		let title = apodData.title
		let date = dateToString(date: apodData.date)
		let explanation = apodData.explanation
		let copyright = apodData.copyright

		let text = makeText(date: date, explanation: explanation, copyright: copyright)

		return ApodDataViewModel(title: title, text: text)
	}

	private func dateToString(date: Date) -> String {
		let formatter = DateFormatter()
		formatter.dateFormat = dateFormat
		return formatter.string(from: date)
	}

	private func makeText(date: String, explanation: String, copyright: String) -> String {
		var text = date + "\r\n"
		text = text + "\r\n"
		text = text + explanation + "\r\n"
		text = text + "\r\n"
		text = text +  copyrightHeader
		if copyright.isEmpty {
			text = text + publicDomain
		} else {
			text = text + copyright
		}

		return text
	}

	// MARK: - presentError
	func presentError(response: ApodErrorResponse) {
		let viewModel = ApodErrorViewModel(errorMessage: response.error.localizedDescription)
		output.displayApodError(viewModel: viewModel)
	}

	// MARK: - presentPictureDownloadProgress
	func presentPictureDownloadProgress(response: ApodPictureDownloadProgressResponse) {
		let viewModel = ApodPictureDownloadProgressViewModel(progressRatio: Float(response.progressRatio))
		output.displayProgress(viewModel: viewModel)
	}

	// MARK: - presentPicture
	func presentPicture(response: ApodPictureResponse) {
		let viewModel = ApodImageViewModel(picture: response.picture)
		output.displayImage(viewModel: viewModel)
	}

}
